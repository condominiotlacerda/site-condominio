<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal da Transparência</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilo para o iframe de forma responsiva */
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen">
    <div class="relative w-full max-w-full p-6 bg-white rounded-xl shadow-lg">

        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-2xl font-bold text-gray-800">Portal da Transparência</h1>
        </div>

        <div class="mb-4">
            <label for="sheetSelector" class="block text-sm font-medium text-gray-700 mb-2">Selecione a Planilha:</label>
            <select id="sheetSelector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm bg-white border border-gray-300 appearance-none">
            </select>
            <p class="mt-2 text-sm text-gray-600">Visualizando: <span id="sheetTitle" class="font-medium text-gray-800">Carregando...</span></p>
        </div>

        <div class="w-full h-[600px] rounded-lg overflow-hidden border border-gray-200 shadow-sm">
            <iframe id="googleSheetIframe" src=""></iframe>
        </div>

    </div>

    <script type="module">
        // Importa as funções de autenticação do Firebase.
        import { signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Importa a instância do app Firebase e a instância de auth do SEU arquivo firebase.js.
        // Importa logAccess do script.js, que agora será o responsável pelo logging.
        import { app, auth } from '../firebase.js'; 
        import { logAccess } from '../script.js'; // <-- Importa logAccess do script.js
        
        // As variáveis '__firebase_config' e '__initial_auth_token' não são mais necessárias
        // já que estamos usando signInAnonymously e as instâncias de 'app' e 'auth' do firebase.js.

        // Função de autenticação anônima
        async function authenticate() {
            try {
                await signInAnonymously(auth); // Autentica anonimamente
            } catch (error) {
                console.error("Erro na autenticação:", error);
                // Loga o erro de autenticação usando a função logAccess importada do script.js
                logAccess({
                    accessedDocument: 'Portal da Transparencia HTML',
                    details: {
                        error: error.message,
                        context: 'Firebase Auth Error',
                        page: 'transparencia.html',
                        actionType: 'Auth Fail'
                    }
                });
            }
        }
        
        window.addEventListener('load', async () => {
            // Autentica o usuário ao carregar a página
            await authenticate();

            // Lógica para o seletor de planilhas
            const sheetSelector = document.getElementById('sheetSelector');
            const googleSheetIframe = document.getElementById('googleSheetIframe');
            const sheetTitleSpan = document.getElementById('sheetTitle');

            if (sheetSelector && googleSheetIframe && sheetTitleSpan) {
                // Certifique-se de que esta URL base está correta para sua planilha publicada
                const sheetBaseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf07OSWqU0f_dGSVSK86HpsECXqhpDKCGGtidysYdLZQw6Mm8cZw4PYi9k0Mox-nI9fiwF6eByTfe/pubhtml";
                const sheetParams = "&single=true&widget=true&headers=false";

                try {
                    // Mantenha './gids.json' se transparencia.html e gids.json estão na mesma pasta.
                    const response = await fetch('./gids.json'); 
                    const gidsData = await response.json();

                    // Popula o seletor com as opções do JSON (agora com grupos de anos)
                    gidsData.forEach(yearGroup => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = yearGroup.year; // O label do grupo será o ano

                        yearGroup.months.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.gid || ''; // Use '' se o GID for null
                            option.textContent = item.title;
                            option.disabled = (item.gid === null); // Desabilita se o GID for null

                            // Define a primeira opção com GID não nulo como selecionada por padrão
                            if (!sheetSelector.querySelector('optgroup option[selected]') && item.gid !== null) {
                                option.selected = true;
                            }
                            optgroup.appendChild(option);
                        });
                        sheetSelector.appendChild(optgroup);
                    });

                    // Função para atualizar o iframe, o título e REGISTRAR O LOG
                    function updateIframeAndTitle(isInitialLoad = false) {
                        const newGid = sheetSelector.value;
                        const selectedOption = sheetSelector.options[sheetSelector.selectedIndex];
                        const newTitle = selectedOption.textContent;
                        
                        // Atualiza o iframe
                        if (newGid) { // Só atualiza o iframe se um GID válido for selecionado
                            googleSheetIframe.src = `${sheetBaseUrl}?gid=${newGid}${sheetParams}`;
                        } else {
                            googleSheetIframe.src = ""; // Limpa o iframe se GID for nulo
                        }
                        
                        sheetTitleSpan.textContent = newTitle;

                        // REGISTRA O LOG usando a função logAccess importada do script.js
                        logAccess({
                            accessedDocument: 'Portal da Transparencia HTML', // Documento base
                            details: {
                                selectedSheet: newTitle,
                                gid: newGid,
                                page: 'transparencia.html',
                                actionType: isInitialLoad ? 'Load Page' : 'Sheet Selector Change' // Diferencia o tipo de ação
                            }
                        });
                    }

                    // Atualiza o iframe e o título imediatamente ao carregar a página
                    updateIframeAndTitle(true); // Passa true para indicar que é a carga inicial
                    
                    // Adiciona o listener para atualizar quando a seleção mudar
                    sheetSelector.addEventListener('change', () => updateIframeAndTitle(false)); // Passa false para indicar mudança manual

                } catch (error) {
                    console.error("Erro ao carregar os GIDs do arquivo gids.json:", error);
                    sheetTitleSpan.textContent = "Erro ao carregar planilhas.";
                    // Loga o erro também usando a função logAccess importada do script.js
                    logAccess({
                        accessedDocument: 'Portal da Transparencia HTML',
                        details: {
                            error: error.message,
                            context: 'gids.json load error',
                            page: 'transparencia.html',
                            actionType: 'Error'
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
