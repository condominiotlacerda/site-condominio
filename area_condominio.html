<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script type="module">
    // 游댠 Firebase Setup and Authentication Logic 游댠
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBzgHcrZNvCQEunq-d3LeDm0u4LDhwjDgM",
        authDomain: "logsite-d81dd.firebaseapp.com",
        databaseURL: "https://logsite-d81dd-default-rtdb.firebaseio.com",
        projectId: "logsite-d81dd",
        storageBucket: "logsite-d81dd.firebasestorage.app",
        messagingSenderId: "285508603780",
        appId: "1:285508603780:web:dba70ace036ee8a37297d1",
        measurementId: "G-B0JHRHTNKF"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase();
    const auth = getAuth(app);

    logEvent(analytics, 'page_view'); // Registra a visualiza칞칚o da p치gina

    const authInstance = getAuth(app);

    onAuthStateChanged(authInstance, (user) => {
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                signOut(authInstance).then(() => {
                    console.log('Usu치rio deslogado com sucesso.');
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Erro ao deslogar:', error);
                    alert('Ocorreu um erro ao deslogar. Por favor, tente novamente.');
                });
            });
        }

        const currentUser = authInstance.currentUser;

        if (!currentUser) {
            console.log("Usu치rio n칚o autenticado no carregamento, redirecionando...");
            window.location.href = 'index.html';
        } else {
            console.log("Usu치rio autenticado no carregamento:", currentUser.uid);
        }
    });

    let inactivityTimeout = 3 * 60 * 1000; // 3 minutos em milissegundos
    let timeoutId;

    function resetInactivityTimer() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            signOut(authInstance).then(() => {
                console.log('Usu치rio deslogado por inatividade.');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Erro ao deslogar por inatividade:', error);
            });
        }, inactivityTimeout);
    }

    resetInactivityTimer();
    document.addEventListener('mousemove', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);

    window.addEventListener('beforeunload', () => {
        signOut(authInstance).then(() => {
            console.log('Usu치rio deslogado ao fechar a aba/navegador.');
        }).catch((error) => {
            console.error('Erro ao deslogar ao fechar:', error);
        });
    });

    // Fun칞칚o para registrar acessos (a l칩gica permanece aqui)
    function logAccess(userCode, userName, apartment, accessedDocument) {
        const db = getDatabase();
        let now = new Date();
        now.setHours(now.getHours() - 3);
        const formattedDate = now.toISOString().replace('T', '_').split('.')[0];
        let fileName = `${userName}_Acesso_apartamento_${apartment}_${accessedDocument}_${userCode}_${formattedDate}`;
        fileName = fileName.replace(/[^a-zA-Z0-9_-]/g, '_');
        const accessLog = { userCode: userCode, userName: userName, apartment: `Acesso ao apartamento ${apartment}`, accessedDocument: accessedDocument, accessDate: now.toISOString() };
        const logRef = ref(db, `logs/${fileName}`);
        set(logRef, accessLog)
            .then(() => console.log("Log registrado com hor치rio correto:", now.toISOString()))
            .catch(error => console.error("Erro ao registrar log:", error));
    }
    window.logAccess = logAccess;
</script>
    <button id="logoutButton">Sair</button>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css?v=1.1">
    <title>Condom칤nio T Lacerda - Boletos e Contas</title>
    <script src="script.js" defer type="module"></script>
</head>
<body>
    <header>
        <img src="images/logo_cond.jpg" alt="Logo do Condom칤nio" class="logo">
    </header>

    <div class="container">
        <section id="content">

        </section>

        <h1>Condom칤nio T Lacerda</h1>
        <p id="welcome-message">Ol치! Eu sou a Lacerda, assistente virtual do Condom칤nio T Lacerda.<br>Por favor, digite seu c칩digo de acesso.</p>
        <input type="password" id="accessCode" placeholder="Digite seu c칩digo">
        <button onclick="enableApartment()">Acessar</button>

        <div class="apartment-section">
            <button class="apartment-button" id="apto1" disabled onclick="showFiles('1')">Apartamento 1</button>
            <button class="apartment-button" id="apto101" disabled onclick="showFiles('101')">Apartamento 101</button>
            <button class="apartment-button" id="apto102" disabled onclick="showFiles('102')">Apartamento 201</button>
            <button class="apartment-button" id="apto201" disabled onclick="showFiles('201')">Apartamento 201</button>
            <button class="apartment-button" id="apto202" disabled onclick="showFiles('202')">Apartamento 202</button>
            <button class="apartment-button" id="apto301" disabled onclick="showFiles('301')">Apartamento 301</button>
            <button class="apartment-button" id="apto302" disabled onclick="showFiles('302')">Apartamento 302</button>
            <button class="apartment-button" id="apto401" disabled onclick="showFiles('401')">Apartamento 401</button>
        </div>

        <section id="login" style="display:none;">
            <h2>Login</h2>
            <form id="formularioLogin">
                <label for="emailLogin">Email:</label><br>
                <input type="email" id="emailLogin" name="emailLogin" required><br><br>
                <label for="senhaLogin">Senha:</label><br>
                <input type="password" id="senhaLogin" name="senhaLogin" required><br><br>
                <button type="submit">Entrar</button>
                <div id="mensagemLogin"></div>
            </form>
            <p>N칚o tem uma conta? <a href="#" id="mostrarCadastro">Cadastre-se</a></p>
        </section>

        <section id="cadastro" style="display:none;">
            <h2>Cadastro</h2>
            <form id="formularioCadastro">
                <label for="emailCadastro">Email:</label><br>
                <input type="email" id="emailCadastro" name="emailCadastro" required><br><br>
                <label for="senhaCadastro">Senha:</label><br>
                <input type="password" id="senhaCadastro" name="senhaCadastro" required><br><br>
                <label for="codigoAcesso">C칩digo de Acesso:</label><br>
                <input type="text" id="codigoAcesso" name="codigoAcesso" placeholder="Seu C칩digo de Acesso"><br><br>
                <button type="submit">Cadastrar</button>
                <div id="mensagemCadastro"></div>
            </form>
            <p>J치 tem uma conta? <a href="#" id="mostrarLogin">Fa칞a login</a></p>
        </section>
    </div>

    <footer>
        <p>&copy; 2025 Portal do Condom칤nio. Todos os direitos reservados.</p>
        <p style="font-size: 0.8em;">Solu칞칚o desenvolvida por Jo칚o Marcelo, Unidade 301.</p>
    </footer>

    <script src="script.js"></script>
</body>
</html>
