<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css?v=1.1">
    <title>Condom√≠nio T Lacerda - Login</title>

    <script type="module">
        // ==================== üî• IN√çCIO FIREBASE üî• ====================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        import { app } from './firebase.js';

        const forgotPasswordLink = document.getElementById('forgotPassword');
        const forgotPasswordSection = document.getElementById('forgotPasswordSection');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const mensagemForgotPassword = document.getElementById('mensagemForgotPassword');
        const mostrarLoginFromForgotLink = document.getElementById('mostrarLoginFromForgot');
        const loginSection = document.getElementById('login');
        const cadastroSection = document.getElementById('cadastro');
        const mostrarCadastroLink = document.getElementById('mostrarCadastro');
        const mostrarLoginLink = document.getElementById('mostrarLogin');

        if (forgotPasswordLink) {
            forgotPasswordLink.addEventListener('click', function(event) {
                event.preventDefault();
                loginSection.style.display = 'none';
                forgotPasswordSection.style.display = 'block';
            });
        }

        if (mostrarLoginFromForgotLink) {
            mostrarLoginFromForgotLink.addEventListener('click', function(event) {
                event.preventDefault();
                forgotPasswordSection.style.display = 'none';
                loginSection.style.display = 'block';
            });
        }

        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const emailForgotPassword = document.getElementById('emailForgotPassword').value;
                const auth = getAuth();

                sendPasswordResetEmail(auth, emailForgotPassword)
                    .then(() => {
                        mensagemForgotPassword.textContent = 'Um link para redefinir sua senha foi enviado para o seu e-mail.';
                    })
                    .catch((error) => {
                        const errorCode = error.code;
                        const errorMessage = error.message;
                        mensagemForgotPassword.textContent = 'Erro ao enviar o e-mail de recupera√ß√£o: ' + errorMessage;
                        console.error('Erro ao enviar e-mail de recupera√ß√£o:', errorCode, errorMessage);
                    });
            });
        }

        // Initialize Firebase
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        if (mostrarCadastroLink) {
            mostrarCadastroLink.addEventListener('click', function(event) {
                event.preventDefault();
                loginSection.style.display = 'none';
                cadastroSection.style.display = 'block';
            });
        }

        if (mostrarLoginLink) {
            mostrarLoginLink.addEventListener('click', function(event) {
                event.preventDefault();
                cadastroSection.style.display = 'none';
                loginSection.style.display = 'block';
            });
        }

        const formularioLogin = document.getElementById('formularioLogin');
        if (formularioLogin) {
            formularioLogin.addEventListener('submit', async function(event) {
                event.preventDefault();
                const emailLogin = document.getElementById('emailLogin').value;
                const senhaLogin = document.getElementById('senhaLogin').value;
                const mensagemLogin = document.getElementById('mensagemLogin');

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, emailLogin, senhaLogin);
                    const user = userCredential.user;
                    console.log("Usu√°rio logado com sucesso:", user.uid);
                    const pendingRef = ref(db, 'pendingApprovals/' + user.uid);
                    const snapshot = await get(pendingRef);

                    if (snapshot.exists()) {
                        mensagemLogin.textContent = 'Seu acesso ainda est√° pendente de aprova√ß√£o. Por favor, aguarde.';
                    } else {
                        mensagemLogin.textContent = 'Login realizado com sucesso!';
                        const userDetailsRef = ref(db, 'userApartments/' + user.uid);
                        const userSnapshot = await get(userDetailsRef);

                        if (userSnapshot.exists() && userSnapshot.val().apartmentId) {
                            const apartmentId = userSnapshot.val().apartmentId;
                            const userNameFromDB = userSnapshot.val().userName;
                            console.log("userNameFromDB (Realtime Database):", userNameFromDB);
                            console.log('Apartment ID from DB (before storage):', apartmentId);
                            localStorage.setItem('apartmentId', apartmentId);
                            localStorage.setItem('userName', userNameFromDB);

                            // Redirecionar ap√≥s 1.5 segundos para dar tempo de ler a mensagem
                            setTimeout(() => {
                                window.location.href = 'area_condominio.html';
                            }, 1500); // 1.5 segundos
                        } else {
                            console.error("apartmentId n√£o encontrado para o usu√°rio:", user.uid);
                            mensagemLogin.textContent = 'Erro ao carregar informa√ß√µes do seu apartamento. Tente novamente mais tarde.';
                        }
                    }
                } catch (error) {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.log("C√≥digo de erro:", errorCode);

                    if (errorCode === 'auth/invalid-email') {
                        mensagemLogin.textContent = 'O email digitado √© inv√°lido.';
                    } else if (errorCode === 'auth/invalid-credential') {
                        mensagemLogin.innerHTML = 'E-mail e/ou senha incorretos.<br>Verifique se voc√™ digitou corretamente suas credenciais.<br>Se voc√™ esqueceu sua senha, use o link "Esqueci minha senha".';
                    } else {
                        mensagemLogin.textContent = 'Erro ao fazer login: ' + errorMessage;
                    }

                }
            });
        }

        // --- Novo Script para abrir o hist√≥rico PDF ---
        document.addEventListener('DOMContentLoaded', () => {
            const historicoLink = document.getElementById('historico-link');
            const historicoViewer = document.getElementById('historico-viewer');
            const historicoIframe = document.getElementById('historico-iframe');
            const closeHistorico = document.getElementById('close-historico');
            const mainContent = document.querySelector('.main-wrapper'); // Seu conte√∫do principal
            const loginSection = document.getElementById('login'); // Sua se√ß√£o de login
            const forgotPasswordSection = document.getElementById('forgotPasswordSection'); // Sua se√ß√£o de recupera√ß√£o
            const cadastroSection = document.getElementById('cadastro'); // Sua se√ß√£o de cadastro


            historicoLink.addEventListener('click', (e) => {
                e.preventDefault(); // Impede o comportamento padr√£o do link

                // Oculta os formul√°rios de login/cadastro/recupera√ß√£o
                if (loginSection) loginSection.style.display = 'none';
                if (forgotPasswordSection) forgotPasswordSection.style.display = 'none';
                if (cadastroSection) cadastroSection.style.display = 'none';
                
                // Oculta a fachada
                const imageColumn = document.querySelector('.image-column');
                if (imageColumn) imageColumn.style.display = 'none';


                historicoIframe.src = 'historico/historico.pdf'; // Define o caminho do PDF
                historicoViewer.style.display = 'block'; // Mostra o painel do visualizador
                historicoViewer.classList.add('active'); // Adiciona classe para transi√ß√£o/estilo
            });

            closeHistorico.addEventListener('click', () => {
                historicoViewer.style.display = 'none'; // Esconde o painel
                historicoViewer.classList.remove('active'); // Remove a classe
                historicoIframe.src = ''; // Limpa o iframe para parar o carregamento do PDF

                // Reexibe os elementos originais (apenas o login, se os outros estiverem hidden)
                if (loginSection) loginSection.style.display = 'block';
                 // Reexibe a fachada se o login estiver vis√≠vel (ou se for o estado padr√£o)
                const imageColumn = document.querySelector('.image-column');
                if (imageColumn && loginSection.style.display !== 'none') {
                    imageColumn.style.display = 'block';
                }
            });
        });
    </script>
</head>
<body>
    <header>
        <img src="images/logo_cond.jpg" alt="Logo do Condom√≠nio" class="logo">
    </header>

    <nav class="top-nav-bar">
        <a href="#" class="nav-item" id="historico-link">Hist√≥rico</a>
        <a href="#" class="nav-item">Galeria</a>
        <a href="#" class="nav-item">Regulamento</a>
    </nav>

    <div class="main-wrapper">
        <div id="historico-viewer" class="viewer-box" style="display: none;">
            <button id="close-historico" class="close-btn">&times;</button>
            <h2>Hist√≥rico do Condom√≠nio</h2>
            <iframe id="historico-iframe" width="100%" height="500px" frameborder="0"></iframe>
            <a id="download-historico" href="historico/historico.pdf" download="Historico_Condominio.pdf" class="download-btn">Baixar Hist√≥rico</a>
        </div>
        <div class="image-column">
        </div>

        <div class="form-column">
            <section id="login">
                <h2>Login</h2>
                <form id="formularioLogin">
                    <div class="input-group">
                        <label for="emailLogin">Email:</label>
                        <input type="email" id="emailLogin" name="emailLogin" placeholder="Seu email" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="senhaLogin">Senha:</label>
                        <input type="password" id="senhaLogin" name="senhaLogin" maxlength="6" inputmode="numeric" placeholder="Sua senha">
                    </div>
                    
                    <button type="submit">Entrar</button>
                    
                    <a href="#" id="forgotPassword">Esqueci minha senha</a>
                    <div id="mensagemLogin"></div>
                </form>
                <p>N√£o tem uma conta? <a href="#" id="mostrarCadastro">Cadastre-se</a></p>
            </section>

            <section id="forgotPasswordSection" style="display:none;">
                <h2>Recuperar Senha</h2>
                <form id="forgotPasswordForm">
                    <div class="input-group">
                        <label for="emailForgotPassword">Email:</label>
                        <input type="email" id="emailForgotPassword" name="emailForgotPassword" placeholder="Seu email" required>
                    </div>
                    
                    <button type="submit">Enviar link de recupera√ß√£o</button>
                    <div id="mensagemForgotPassword"></div>
                </form>
                <p><a href="#" id="mostrarLoginFromForgot">Voltar para o Login</a></p>
            </section>

            <section id="cadastro" style="display:none;">
                <h2>Cadastro</h2>
                <form id="formularioCadastro">
                    <div class="input-group">
                        <label for="emailCadastro">Email:</label>
                        <input type="email" id="emailCadastro" name="emailCadastro" placeholder="Seu email" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="senhaCadastro">Senha:</label>
                        <input type="password" id="senhaCadastro" name="senhaCadastro" maxlength="6" inputmode="numeric" placeholder="Sua senha">
                    </div>
                    
                    <div class="input-group">
                        <label for="codigoAcesso">C√≥digo de Acesso:</label>
                        <input type="text" id="codigoAcesso" name="codigoAcesso" placeholder="Seu C√≥digo de Acesso">
                    </div>
                    
                    <button type="submit">Cadastrar</button>
                    <div id="mensagemCadastro"></div>
                </form>
                <p>J√° tem uma conta? <a href="#" id="mostrarLogin">Fa√ßa login</a></p>
            </section>

        </div>
    </div>
    <footer>
        <p>&copy; 2025 Portal do Condom√≠nio. Todos os direitos reservados.</p>
        <p style="font-size: 0.8em; text-align: center;">U 301.</p>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const senhaCadastroInput = document.getElementById('senhaCadastro');
    const senhaLoginInput = document.getElementById('senhaLogin');

    if (senhaCadastroInput) {
        senhaCadastroInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, ''); // Remove n√£o num√©ricos
            if (this.value.length > this.maxLength) {
                this.value = this.value.slice(0, this.maxLength);
            }
        });
    }

    if (senhaLoginInput) {
        senhaLoginInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, ''); // Remove n√£o num√©ricos
            if (this.value.length > this.maxLength) {
                this.value = this.value.slice(0, this.maxLength);
            }
        });
    }
});
</script>
<script src="script.js" defer type="module"></script>
</body>
</html>
