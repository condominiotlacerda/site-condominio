<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <link rel="stylesheet" href="styles.css?v=1.1">
Â  Â  <title>CondomÃ­nio T Lacerda - Login</title>

Â  Â  <script type="module">
        import { fetchDatabaseURL } from './utils.js';
Â  Â  Â  Â  // ==================== ðŸ”¥ INÃCIO FIREBASE ðŸ”¥ ====================
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
Â  Â  Â  Â  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
Â  Â  Â  Â  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
Â  Â  Â  Â  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

Â  Â  Â  Â  const firebaseConfig = {
                apiKey: "AIzaSyBzgHcrZNvCQEunq-d3LeDm0u4LDhwjDgM",
                authDomain: "logsite-d81dd.firebaseapp.com",
                // databaseURL: "https://logsite-d81dd-default-rtdb.firebaseio.com",
                projectId: "logsite-d81dd",
                appId: "1:285508603780:web:dba70ace036ee8a37297d1"
            };
                
        /*        
        const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyBzgHcrZNvCQEunq-d3LeDm0u4LDhwjDgM",
Â  Â  Â  Â  Â  Â  authDomain: "logsite-d81dd.firebaseapp.com",
Â  Â  Â  Â  Â  Â  databaseURL: "https://logsite-d81dd-default-rtdb.firebaseio.com",
Â  Â  Â  Â  Â  Â  projectId: "logsite-d81dd",
Â  Â  Â  Â  Â  Â  storageBucket: "logsite-d81dd.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "285508603780",
Â  Â  Â  Â  Â  Â  appId: "1:285508603780:web:dba70ace036ee8a37297d1",
Â  Â  Â  Â  Â  Â  measurementId: "G-B0JHRHTNKF"
Â  Â  Â  Â  };
        */
      
        
Â  Â  Â  Â  const forgotPasswordLink = document.getElementById('forgotPassword');
Â  Â  Â  Â  const forgotPasswordSection = document.getElementById('forgotPasswordSection');
Â  Â  Â  Â  const forgotPasswordForm = document.getElementById('forgotPasswordForm');
Â  Â  Â  Â  const mensagemForgotPassword = document.getElementById('mensagemForgotPassword');
Â  Â  Â  Â  const mostrarLoginFromForgotLink = document.getElementById('mostrarLoginFromForgot');
Â  Â  Â  Â  const loginSection = document.getElementById('login');
Â  Â  Â  Â  const cadastroSection = document.getElementById('cadastro');
Â  Â  Â  Â  const mostrarCadastroLink = document.getElementById('mostrarCadastro');
Â  Â  Â  Â  const mostrarLoginLink = document.getElementById('mostrarLogin');

Â  Â  Â  Â  if (forgotPasswordLink) {
Â  Â  Â  Â  Â  Â  forgotPasswordLink.addEventListener('click', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  loginSection.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  forgotPasswordSection.style.display = 'block';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (mostrarLoginFromForgotLink) {
Â  Â  Â  Â  Â  Â  mostrarLoginFromForgotLink.addEventListener('click', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  forgotPasswordSection.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  loginSection.style.display = 'block';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (forgotPasswordForm) {
Â  Â  Â  Â  Â  Â  forgotPasswordForm.addEventListener('submit', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  const emailForgotPassword = document.getElementById('emailForgotPassword').value;
Â  Â  Â  Â  Â  Â  Â  Â  const auth = getAuth();

Â  Â  Â  Â  Â  Â  Â  Â  sendPasswordResetEmail(auth, emailForgotPassword)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemForgotPassword.textContent = 'Um link para redefinir sua senha foi enviado para o seu e-mail.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorCode = error.code;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMessage = error.message;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemForgotPassword.textContent = 'Erro ao enviar o e-mail de recuperaÃ§Ã£o: ' + errorMessage;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao enviar e-mail de recuperaÃ§Ã£o:', errorCode, errorMessage);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Initialize Firebase
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const analytics = getAnalytics(app);
Â  Â  Â  Â  const db = getDatabase(app);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const firestore = getFirestore(app);

Â  Â  Â  Â  // FunÃ§Ã£o para registrar acessos no Firebase com horÃ¡rio correto (UTC-3)
Â  Â  Â  Â  function logAccess(userCode, userName, apartment, accessedDocument, databaseURL) {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  now.setHours(now.getHours() - 3);
Â  Â  Â  Â  Â  Â  const formattedDate = now.toISOString().replace('T', '_').split('.')[0];
Â  Â  Â  Â  Â  Â  let fileName = `${userName}_Acesso_apartamento_${apartment}_${accessedDocument}_${userCode}_${formattedDate}`;
Â  Â  Â  Â  Â  Â  fileName = fileName.replace(/[^a-zA-Z0-9_-]/g, '_');
Â  Â  Â  Â  Â  Â  const accessLog = {
Â  Â  Â  Â  Â  Â  Â  Â  userCode: userCode,
Â  Â  Â  Â  Â  Â  Â  Â  userName: userName,
Â  Â  Â  Â  Â  Â  Â  Â  apartment: `Acesso ao apartamento ${apartment}`,
Â  Â  Â  Â  Â  Â  Â  Â  accessedDocument: accessedDocument,
Â  Â  Â  Â  Â  Â  Â  Â  accessDate: now.toISOString()
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const logRef = ref(db, `logs/${fileName}`);
Â  Â  Â  Â  Â  Â  set(logRef, accessLog)
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log("Log registrado com horÃ¡rio correto:", now.toISOString()))
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.error("Erro ao registrar log:", error));
Â  Â  Â  Â  }

Â  Â  Â  Â  window.logAccess = logAccess;

Â  Â  Â  Â  if (mostrarCadastroLink) {
Â  Â  Â  Â  Â  Â  mostrarCadastroLink.addEventListener('click', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  loginSection.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  cadastroSection.style.display = 'block';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (mostrarLoginLink) {
Â  Â  Â  Â  Â  Â  mostrarLoginLink.addEventListener('click', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  cadastroSection.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  loginSection.style.display = 'block';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const formularioLogin = document.getElementById('formularioLogin');
Â  Â  Â  Â  if (formularioLogin) {
Â  Â  Â  Â  Â  Â  formularioLogin.addEventListener('submit', async function(event) {
            event.preventDefault();
            const emailLogin = document.getElementById('emailLogin').value;
            const senhaLogin = document.getElementById('senhaLogin').value;
            const mensagemLogin = document.getElementById('mensagemLogin');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, emailLogin, senhaLogin);
                const user = userCredential.user;
                console.log("UsuÃ¡rio logado com sucesso:", user.uid);
                const pendingRef = ref(db, 'pendingApprovals/' + user.uid);
                const snapshot = await get(pendingRef);

                if (snapshot.exists()) {
                    mensagemLogin.textContent = 'Seu acesso ainda estÃ¡ pendente de aprovaÃ§Ã£o. Por favor, aguarde.';
                } else {
                    mensagemLogin.textContent = 'Login realizado com sucesso!';
                    const userDetailsRef = ref(db, 'userApartments/' + user.uid);
                    const userSnapshot = await get(userDetailsRef);

                    if (userSnapshot.exists() && userSnapshot.val().apartmentId) {
                        const apartmentId = userSnapshot.val().apartmentId;
                        console.log('Apartment ID from DB (before storage):', apartmentId);
                        localStorage.setItem('apartmentId', apartmentId);

                        const invitesRef = collection(firestore, 'invites');
                        const q = query(invitesRef, where('apartment', '==', apartmentId));
                        getDocs(q)
                            .then((querySnapshot) => {
                                console.log('QuerySnapshot size:', querySnapshot.size); // Adicione esta linha
                                if (!querySnapshot.empty) {
                                    querySnapshot.forEach((doc) => {
                                        const userData = doc.data();
                                        const userName = userData.name;
                                        localStorage.setItem('userName', userName);
                                        console.log('User Name (fetched from Firestore in index.html):', userName);
                                        window.location.href = 'area_condominio.html';
                                    });
                                } else {
                                    console.log("No user found in invites for apartment:", apartmentId);
                                    window.location.href = 'area_condominio.html';
                                }
                            })
                            .catch((error) => {
                                console.error("Error fetching user name from Firestore in index.html:", error);
                                window.location.href = 'area_condominio.html';
                            });
                    } else {
                        console.error("apartmentId nÃ£o encontrado para o usuÃ¡rio:", user.uid);
                        mensagemLogin.textContent = 'Erro ao carregar informaÃ§Ãµes do seu apartamento. Tente novamente mais tarde.';
                    }
                }
            } catch (error) {
                console.log("Erro capturado:", error); // Log do objeto de erro completo
                const errorCode = error?.code;
                const errorMessage = error?.message;
                console.log("CÃ³digo de erro:", errorCode);

                if (errorCode === 'auth/invalid-email') {
                    mensagemLogin.textContent = 'O email digitado Ã© invÃ¡lido.';
                } else if (errorCode === 'auth/invalid-credential') {
                    mensagemLogin.innerHTML = 'E-mail e/ou senha incorretos.<br>Verifique se vocÃª digitou corretamente suas credenciais.<br>Se vocÃª esqueceu sua senha, use o link "Esqueci minha senha".';
                } else {
                    if (errorMessage) {
                        mensagemLogin.textContent = 'Erro ao fazer login: ' + errorMessage;
                    } else {
                        mensagemLogin.textContent = 'Ocorreu um erro ao fazer login.';
                    }
                }

                console.error("Erro ao fazer login:", errorCode, errorMessage);
            }
        });
Â  Â  Â  Â  }
Â  Â  </script>
</head>
    
<body>
Â  Â  <header>
Â  Â  Â  Â  <img src="images/logo_cond.jpg" alt="Logo do CondomÃ­nio" class="logo">
Â  Â  </header>
Â  Â  <section id="login">
Â  Â  Â  Â  <h2>Login</h2>
Â  Â  Â  Â  <form id="formularioLogin">
Â  Â  Â  Â  Â  Â  <label for="emailLogin">Email:</label><br>
Â  Â  Â  Â  Â  Â  <input type="email" id="emailLogin" name="emailLogin" required style="width: 270px;"><br><br>
Â  Â  Â  Â  Â  Â  <label for="senhaLogin">Senha:</label><br>
Â  Â  Â  Â  Â  Â  <input type="password" id="senhaLogin" name="senhaLogin" maxlength="6" inputmode="numeric"><br><br>
Â  Â  Â  Â  Â  Â  <button type="submit" style="margin-right: 10px;">Entrar</button><br><br>
Â  Â  Â  Â  Â  Â  <a href="#" id="forgotPassword">Esqueci minha senha</a><br>
Â  Â  Â  Â  Â  Â  <div id="mensagemLogin"></div>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  <p>NÃ£o tem uma conta? <a href="#" id="mostrarCadastro">Cadastre-se</a></p>
Â  Â  </section>

Â  Â  <section id="forgotPasswordSection" style="display:none;">
Â  Â  Â  Â  <h2>Recuperar Senha</h2>
Â  Â  Â  Â  <form id="forgotPasswordForm">
Â  Â  Â  Â  Â  Â  <label for="emailForgotPassword">Email:</label><br><br>
Â  Â  Â  Â  Â  Â  <input type="email" id="emailForgotPassword" name="emailForgotPassword" required><br><br>
Â  Â  Â  Â  Â  Â  <button type="submit">Enviar link de recuperaÃ§Ã£o</button><br><br>
Â  Â  Â  Â  Â  Â  <div id="mensagemForgotPassword"></div>
Â  Â  Â  Â  </form>
Â  Â  <p><a href="#" id="mostrarLoginFromForgot">Voltar para o Login</a></p>
Â  Â  </section>

Â  Â  <section id="cadastro" style="display:none;">
Â  Â  Â  Â  <h2>Cadastro</h2>
Â  Â  Â  Â  <form id="formularioCadastro">
Â  Â  Â  Â  Â  Â  <label for="emailCadastro">Email:</label><br>
Â  Â  Â  Â  Â  Â  <input type="email" id="emailCadastro" name="emailCadastro" required><br><br>
Â  Â  Â  Â  Â  Â  <label for="senhaCadastro">Senha:</label><br>
Â  Â  Â  Â  Â  Â  <input type="password" id="senhaCadastro" name="senhaCadastro" maxlength="6" inputmode="numeric"><br><br>
Â  Â  Â  Â  Â  Â  <label for="codigoAcesso">CÃ³digo de Acesso:</label><br>
Â  Â  Â  Â  Â  Â  <input type="text" id="codigoAcesso" name="codigoAcesso" placeholder="Seu CÃ³digo de Acesso"><br><br>
Â  Â  Â  Â  Â  Â  <button type="submit">Cadastrar</button>
Â  Â  Â  Â  Â  Â  <div id="mensagemCadastro"></div>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  <p>JÃ¡ tem uma conta? <a href="#" id="mostrarLogin">FaÃ§a login</a></p>
Â  Â  </section>

Â  Â  <footer>
Â  Â  Â  Â  <p>&copy; 2025 Portal do CondomÃ­nio. Todos os direitos reservados.</p>
Â  Â  Â  Â  <p style="font-size: 0.8em; text-align: center;">SoluÃ§Ã£o desenvolvida por Unidade 301.</p>
Â  Â  </footer>
  
    <script>
    document.addEventListener('DOMContentLoaded', function() {
Â      const senhaCadastroInput = document.getElementById('senhaCadastro');
Â      const senhaLoginInput = document.getElementById('senhaLogin');

Â      if (senhaCadastroInput) {
Â  Â      senhaCadastroInput.addEventListener('input', function() {
Â  Â  Â      this.value = this.value.replace(/[^0-9]/g, ''); // Remove nÃ£o numÃ©ricos
Â  Â  Â      if (this.value.length > this.maxLength) {
Â  Â  Â      Â  this.value = this.value.slice(0, this.maxLength);
Â  Â  Â      }
Â  Â      });
Â      }

Â      if (senhaLoginInput) {
Â  Â      senhaLoginInput.addEventListener('input', function() {
Â  Â  Â      this.value = this.value.replace(/[^0-9]/g, ''); // Remove nÃ£o numÃ©ricos
Â  Â  Â      if (this.value.length > this.maxLength) {
Â  Â  Â  Â      this.value = this.value.slice(0, this.maxLength);
Â  Â  Â      }
Â  Â      });
Â      }
    });
Â  Â  Â  Â Â 
Â  Â  </script>
    <script src="script.js" defer type="module"></script>
</body>
</html>
